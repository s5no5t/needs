<%= link_to image_tag("arrow_left_alt1_24x24.png"), requirements_path %>

<canvas id="viewport" width="400" height="400"></canvas>

<ul class="requirements_detailed_list" data-bind="foreach: requirement.deriving_requirements">
  <li data-bind="with: deriving_requirement, 
                css: {expanded: deriving_requirement.shouldDisplayBody} ">
    <span class="req_id" data-bind="text: id"></span>
    <span class="title" data-bind="text: title, 
                                   click: $root.toggleDerivingRequirementShouldDisplayBody"></span>
    <%= image_tag "minus_24x6.png", :data => {:bind => "click: $root.remove_deriving_requirement"} %>

    <p data-bind="text: body, visible: shouldDisplayBody"></p>
  </li>
</ul>
<%= image_tag "arrow_up_32x32.png", :class => "centered" %>

<%= render 'form' %>

<script type="text/javascript">
  $(function(){

    var canvas = $("#viewport").get(0);
    var requirementsGraph = needs.requirementsGraph(canvas);

    var requirement_id = <%= @requirement.id %>;

    $.getJSON("/requirements/" + requirement_id + ".json", function(data){
      var that = {};

      var mapped_data = ko.mapping.fromJS(data);

      var requirementViewModel = function(){
        var that = {};

        that.requirement = mapped_data.requirement;

        that.toggleDerivingRequirementShouldDisplayBody = function(){
          this.shouldDisplayBody(!this.shouldDisplayBody());
        };

        that.toggleDerivedRequirementShouldDisplayBody = function(){
          this.derived_requirement.shouldDisplayBody(!this.derived_requirement.shouldDisplayBody());
        };

        that.remove_deriving_requirement = function(item, event){
          mapped_data.requirement.deriving_requirements.remove(function(r){
            return item.id() === r.deriving_requirement.id();
          });
        };

        that.any_deriving_requirements = function(){
          return requirement.deriving_requirements.length > 0;
        };

        that.any_derived_requirements = function(){
          return requirement.derived_requirements.length > 0;
        };

        return that;
      };

      var viewModel = requirementViewModel();

      $(viewModel.requirement.derived_requirements()).each(function(){
        $.extend(this.derived_requirement, {
          shouldDisplayBody: ko.observable(false)
        });
      });
      $(viewModel.requirement.deriving_requirements()).each(function(){
        $.extend(this.deriving_requirement, {
          shouldDisplayBody: ko.observable(false)
        });
      });

      ko.applyBindings(viewModel);
      requirementsGraph.update_graph_for_req(viewModel.requirement);
    });

  });
</script>